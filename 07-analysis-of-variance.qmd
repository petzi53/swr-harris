# Analysis of variance {#sec-chap07}

```{r}
#| label: setup
#| include: false

base::source(file = "R/helper.R")
ggplot2::theme_set(ggplot2::theme_bw()) 
```


```{r}
#| label: cranlogs
#| include: false
#| eval: false

## run only once manually #########
cranlogs_brown_forsythe <-  
    pkgs_dl(c("onewaytests", "car", "doex", "homnormal", "CGPfunctions", "ALSM"))
save_data_file("chap07", cranlogs_brown_forsythe, "cranlogs_brown_forsythe.rds")
```





## Achievements to unlock

::: {#obj-chap07}
::: {.my-objectives}
::: {.my-objectives-header}
Objectives for chapter 07
:::

::: {.my-objectives-container}
**SwR Achievements**

- **Achievement 1**: Exploring the data using graphics and descriptive statistics {@sec-chap07-achievement1}
- **Achievement 2**: Understanding and conducting one-way ANOVA {@sec-chap07-achievement2}
- **Achievement 3**: Choosing and using post hoc tests and contrasts {@sec-chap07-achievement3}
- **Achievement 4**: Computing and interpreting effect sizes for ANOVA {@sec-chap07-achievement4}
- **Achievement 5**: Testing ANOVA assumptions {@sec-chap07-achievement5}
- **Achievement 6**: Choosing and using alternative tests when ANOVA assumptions are not met {@sec-chap07-achievement6}
- **Achievement 7**: Understanding and conducting two-way ANOVA {@sec-chap07-achievement7}

:::
:::
Achievements for chapter 07
:::

`r glossary("ANOVA")` is the statistical method used for comparing means across three or more groups. 

- Like the `r glossary("student", "t-test")`, ANOVA has underlying assumptions.
- Similar to `r glossary("chi-squared")`, ANOVA is an `r glossary("omnibus")` test.
- Instead of using `r glossary("standardized residuals")`, ANOVA uses planned contrasts and post hoc tests.
- Instead of `r glossary("Cramér’s V")` or `r glossary("odds ratio", "odds ratios")` for chi-squared and `r glossary("Cohen’s d")` for t-tests, $η^2$ and $ω^2$ are often reported as `r glossary("effect size", "effect sizes")` for ANOVA.


## The technical difficulties problem (empty)

## Resources & Chapter Outline

### Data, codebook, and R packages {#sec-chap04-data-codebook-packages}

::: {.my-resource}
::: {.my-resource-header}
:::::: {#lem-chap07-resources}
: Data, codebook, and R packages for learning about descriptive statistics
::::::
:::

::: {.my-resource-container}

**Data**


Two options:

1. Download the `gss2018.rda` data set from <https://edge.sagepub.com/harris1e>.
2. Use {**gssr**} to download the year 2018.

(As a direct download with the {**gssr**} package results in labelled data with different column names and the necessary transformation will not gain any additional knowledge for me, I will take the `gss2018.rda` data set from the book.)

**Codebook**

Two options:

1. Access variable documentation (not a full codebook) on the GSS Data Explorer website at <https://gssdataexplorer.norc.org/> 
2. Use the help pages from {**gssr**} package.


**Packages**

1. Packages used with this chapter (sorted alphabetically)

-   {**tidyverse**}: @pak-tidyverse (Hadley Wickham)
-   {**car**): @pak-car (John Fox)
-   {**dunn.test**} @pak-dunn.test (Alexis Dinno)

    
2. My additional packages (sorted alphabetically)



:::
:::



### Get data {#sec-chap07-get-data}

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-get-gss2018-book}
: Get book GSS data set `gss2018.rda` and save it as `gss_2018.rds`
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: get-gss2018-book
#| eval: false
#| cache: true
#| results: hold

## run only once (manually)
## load "GSS" data.frame into memory
base::load("data/chap07/gss2018.rda")

gss_2018 <- GSS
save_data_file("chap07", gss_2018, "gss_2018.rds")
```

(*For this R code chunk is no output available*)
::::
:::::


### Show raw data {#sec-chap07-show-data}

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-show-gss-2018-data}
: Show summary for some `gss_2018` data
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: show-gss-2018-data


gss_2018 <- base::readRDS("data/chap07/gss_2018.rds")
gss_2018 |> 
    dplyr::select(c("USETECH", "HAPPY", "SEX", "AGE", "DEGREE")) |> 
    base::summary()
```
***

- **USETECH**: During a typical week, about what percentage of your total time at work would you normally spend using different types of electronic technologies (such as computers, tablets, smart phones, cash registers, scanners, GPS devices, robotic devices, and so on)?
- **HAPPY**: Taken all together, how would you say things are these days -- would you say that you are very happy, pretty happy, or not too happy?
- **SEX**: Respondent’s sex
- **AGE**: Respondent’s age
- **DEGREE**: Respondent’s highest degree
- 
::::
:::::

:::::{.my-procedure}
:::{.my-procedure-header}
:::::: {#prp-chap07-gss-procedure}
: To get the full information for a variable in GSS
::::::
:::
::::{.my-procedure-container}
1. Go to <https://gssdataexplorer.norc.org/>
2. In the box "Access and Analyze GSS Data" click on the "SEARCH VARIABLES" button.
3. Click at "Select specific years", choose "2018" and confirm by pressing the "Apply"-button.
4. Input the name of the variable "USETECH" into the field and confirm with <enter>.
5. Open "Associated questions" by clicking the `>` symbol or by pressing the "Show Expanded View"-button.
6. Click on the green variable name in the result list to get more detailed information about the variable.
7. In contrast to the result in the book we get a slightly different coding scheme: We got four (not three) values outside the logical range of 0 to 100: -97, -98, -99, -100.

![Screenshot of GSS Data Explorer 2018 USETECH variable values outside logical range](img/chap07/gss-usetech-codes-min.png){#fig-gss-usetech-codebook
fig-alt="Table of the first 10 lines of GSS Data Explorer 2018 USETECH variable values"
fig-align="center"}

::::
:::::

:::::{.my-important}
:::{.my-important-header}
Recoding data exactly as in the book
:::
::::{.my-important-container}
As we are going to use the data set from the book and not the current data set as it is today (2024-03-25) saved at the GSS website, we will for instance USETECH recode -1, 998 and 999 as missing data in our data frame (and not the current values).  

Generally: There is nothing new for me in recoding the data. So I will apply all the necessary recoding in the next subsection in only one R code chunk.
::::
:::::



### Recode data {#sec-chap07-recode-data}

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-recode-gss2018}
: Clean `gss_2018` data
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: recode-gss2018
#| results: hold
#| cache: true


## run only once (manually) ############
gss_2018 <- base::readRDS("data/chap07/gss_2018.rds")

gss_2018_clean <- gss_2018 |> 
    dplyr::select(c("USETECH", "HAPPY", "SEX", "AGE", "DEGREE")) |> 
    dplyr::mutate(USETECH = dplyr::na_if(x = USETECH, y = -1)) |> 
    dplyr::mutate(USETECH = dplyr::na_if(x = USETECH, y = 998)) |>
    dplyr::mutate(USETECH = dplyr::na_if(x = USETECH, y = 999)) |>
    dplyr::mutate(AGE = dplyr::na_if(x = AGE, y = 98)) |>
    dplyr::mutate(AGE = dplyr::na_if(x = AGE, y = 99)) |>
    dplyr::mutate(DEGREE = dplyr::na_if(x = DEGREE, y = 8)) |>
    dplyr::mutate(DEGREE = dplyr::na_if(x = DEGREE, y = 9)) |>
    dplyr::mutate(HAPPY = dplyr::na_if(x = HAPPY, y = 8)) |>
    dplyr::mutate(HAPPY = dplyr::na_if(x = HAPPY, y = 9)) |>
    dplyr::mutate(HAPPY = dplyr::na_if(x = HAPPY, y = 0)) |> 
    
    dplyr::mutate(SEX = forcats::as_factor(SEX)) |> 
    dplyr::mutate(DEGREE = forcats::as_factor(DEGREE)) |> 
    dplyr::mutate(HAPPY = forcats::as_factor(HAPPY)) |> 
    
    dplyr::mutate(SEX = forcats::fct_recode(SEX, 
                                            male = "1", 
                                            female = "2")) |> 
    dplyr::mutate(DEGREE = forcats::fct_recode(DEGREE, 
                                            "< high school" = "0", 
                                            "high school" = "1",
                                            "junior college" = "2",
                                            "bachelor" = "3",
                                            "graduate" = "4")) |> 
    dplyr::mutate(HAPPY = forcats::fct_recode(HAPPY, 
                                        "very happy" = "1",
                                        "pretty happy" = "2",
                                        "not too happy" = "3"))

save_data_file("chap07", gss_2018_clean, "gss_2018_clean.rds")

base::summary(gss_2018_clean)
```

::::
:::::



## Achievement 1: Descriptive statistics {#sec-chap07-achievement1}

The work in this section is done in @sec-chap07-get-data, @sec-chap07-show-data and @sec-chap07-recode-data.

### Explorative Data Analysis (EDA)

**Question to explore**: Do people with higher educational degrees use technology at work more than people with lower degree?

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-eda}
: Explorative Data Analysis (EDA)
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### mean / sd

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-usetech-mean-sd}
: Mean and standard deviation of technology use by respondent’s highest degree
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-chap07-usetech-mean-sd
#| fig-cap: "Mean and standard deviation of technology use by respondent’s highest degree"

gss_2018_clean <- base::readRDS("data/chap07/gss_2018_clean.rds")

usetech_degree <- gss_2018_clean |> 
    tidyr::drop_na(USETECH, DEGREE) |>
    dplyr::group_by(DEGREE) |> 
    dplyr::summarize(mean_usetech = mean(USETECH),
                     sd_usetech = sd(USETECH))
usetech_degree

```
***
It seems that we could affirm our question. With higher degree the value of the mean (representing the percentage of technology usage) is rising. But we have a big standard deviation, especially in the lowest degree group ($sd \approx 1.5 mean$). This could indicate that we have not a normal distribution because of high `r glossary("kurtosis")`, e.g. we could have more observations in the tails than a normal distribution would have (`r glossary("platykurtic")`).

::::
:::::


###### replicate Figure 7.4

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-replicate-7-4}
: Distribution of work time spent using technology by educational attainment
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-replicate-7-4
#| fig-cap: "Distribution of work time spent using technology by educational attainment, using palette 'Spectral' of brewer scales"

gg_gss_2018 <- gss_2018_clean |> 
  tidyr::drop_na(USETECH) |> 
  ggplot2::ggplot(
      ggplot2::aes(
          x = DEGREE,
          y = USETECH
          )
      ) +
  ggplot2::geom_jitter(
      ggplot2::aes(color = DEGREE), alpha = .6
      ) +
  ggplot2::geom_boxplot(
      ggplot2::aes(fill = DEGREE), alpha = .4
      ) +
  ggplot2::scale_fill_brewer(
      palette = "Spectral", 
      guide = "none"
      ) +
  ggplot2::scale_color_brewer(
      palette = "Spectral", 
      guide = "none") +
  ggplot2::theme_bw() +
  ggplot2::labs(
      x = "Highest educational attainment", 
      y = "Percent of time spent using technology"
      )

gg_gss_2018
```
***

Harris uses with this graph (Figure 7.4 in her book) the color schemes from [ColorBrewer](https://colorbrewer2.org/#type=sequential&scheme=BuGn&n=3). See for more details the [color palettes of RColorBrewer](https://renenyffenegger.ch/notes/development/languages/R/packages/RColorBrewer/index) and the [screenshot](https://renenyffenegger.ch/notes/development/languages/R/packages/tmaptools/index#r-tmaptools-palette_explorer) of the `tmaptools::palette_explorer()` function. 

But the chosen color palette is not appropriate for people with color vision deficiency (`r glossary("CVD")`). Mainly the yellow color is problematic as can be demonstrated with the following plot:


```{r}
#| label: fig-check-colorblind-save-gss_2018-plot
colorblindr::cvd_grid(gg_gss_2018)
```


::::
:::::

###### better colors

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-techuse-dist}
: Distribution of work time spent using technology by educational attainment (colorblind save)
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: techuse-dist
#| fig-cap: "Distribution of work time spent using technology by educational attainment, using the color save palette 'Okabe-Ito'"
#| results: hold

gg2_gss_2018 <- gss_2018_clean |> 
  tidyr::drop_na(USETECH) |> 
  ggplot2::ggplot(
      ggplot2::aes(
          x = DEGREE,
          y = USETECH
          )
      ) +
  ggplot2::geom_jitter(
      ggplot2::aes(color = DEGREE), alpha = .6
      ) +
  ggplot2::geom_boxplot(
      ggplot2::aes(fill = DEGREE), alpha = .4
      ) + 
  ggokabeito::scale_color_okabe_ito(guide = "none") +
  ggokabeito::scale_fill_okabe_ito(guide = "none") +
  ggplot2::theme_bw() +
  ggplot2::labs(
      x = "Highest educational attainment", 
      y = "Percent of time spent using technology"
  )

gg2_gss_2018
colorblindr::cvd_grid(gg2_gss_2018)
```

***

Although the color palette "Okabe-Ito" is also using a kind of yellow the result is much better in all CVD variants. Compare it with @fig-check-colorblind-save-gss_2018-plot.
::::
:::::


:::

::::
:::::

What we can see with the graph is that there are many observation at the bottom and at the top of the range of the variable `USETECH`.  

- Many people in the first two categories had selected 0% of their time at work is spent using technology (`r glossary("Floor", "Floor effect")`).
- For all but the first category, there were a lot of people who selected 100% of their time at work is spent using technology (`r glossary("Ceiling", "Ceiling effect")`).

:::::{.my-watch-out}
:::{.my-watch-out-header}
WATCH OUT! ANOVA with floor and ceiling effect
:::
::::{.my-watch-out-container}

When there are floor or ceiling effects, this often means that the variation in a measure is limited by its range. Since ANOVA is an analysis of variance, which examines central tendency and variation together, the limitations of floor and ceiling effects can result in not finding differences when there are differences.

Sometimes floor or ceiling effects are hints that the range of the variable is not chosen correctly. But this does not apply in our case, because the range of using technology from 0 to 100% is as wide as it can be. Besides I believe these extreme values do not relate to the true value of technology use in work. I think that today there is almost no work without some sort of technology support. On the other hand it is no very likely that 100% (every second of work) of technology use is realistic.
::::
:::::

## Achievement 2: Conducting one-way ANOVA {#sec-chap07-achievement2}

### Introduction

You can't apply the `r glossary("t-test")` as a number of different pairwise tests to compare categorical variables that have several levels (groups). The problem is that the `r glossary("Type-1", "Type I error")` piles ab with several tests. For example: With five groups in the `DEGREE` variable, pairwise comparisons with a t-test (i.e., conducting `r glossary("pairwise comparisons")`) would result in 10 t-tests. If each t-test had a p-value threshold of .05 for statistical significance, the probability of at least one Type I error is fairly high.

***

::: {#exp-chap07-type-1-2-errors}

- **Type I error**: A glossary("Type-1", "Type I error")`, also called $\alpha$, is when there is no relationship but the study detects one. The $\alpha$ for Type I error is also the threshold set for statistical significance. The threshold for statistical significance is the amount of uncertainty tolerated in concluding whether or not a result is statistically significant.
- **Type II error**: A `r glossary("Type-2", "Type II error")`, also called $\beta$, occurs when there is a relationship but the study did not detect it.
- **Statistical power**: The power of a statistical test is the probability that the results of the test are not a Type II error.

Definition of Type I and Type II errors
:::
***


:::::{.my-theorem}
:::{.my-theorem-header}
:::::: {#thm-chap07-familywise-type-1}
: Probability of a Type I error when there are multiple comparisons
::::::
:::
::::{.my-theorem-container}
$$
\begin{align*}
\alpha_{f} = 1 - (1 - \alpha_{i})^c \\
c = \frac{k(k-1)}{2}
\end{align*}
$$ {#eq-chap07-familywise-type-1}

***

- $\alpha_{f}$: `r glossary("familywise")` Type I error rate
- $\alpha_{i}$: the individual alpha set as the statistical significance threshold
- $c$: number of comparisons
- $k$: total number of groups

***

For a five-group `DEGREE` variable with $\alpha = .05$ for each pairwise comparison the familywise $\alpha_{f}$ would be:

$$
\begin{align*}
\alpha_{f} = 1-(1-0.05_{i})^\frac{5(5-1)}{2} = \\
\alpha_{f} = 1-(1-0.05_{i})^{10} = 0.4012631
\end{align*}
$$

::::
:::::

> With 10 pairwise comparisons, the familywise $\alpha_{f}$ indicated there would be a 40% probability of making a Type I error. To control this error rate, and for efficiency, use a single ANOVA test instead of 10 t-tests. ANOVA is useful for testing whether three or more means are equal. It can be used with two means, but the t-test is preferable because it is more straightforward.

:::::{.my-remark}
:::{.my-remark-header}
Running many tests
:::
::::{.my-remark-container}
I believe that the problem of a rising Type I error with a growing number of pairwise comparisons is also valid for other type of tests. Each test has the .05 threshold and a collection of many different tests with the same data rises the probability of making a Type I error. Using this strategy consciously is one form of `r glossary("p-hacking")`.
::::
:::::


### F-Test statistic for ANOVA

The F-statistic is a ratio where the variation between the groups is compared to the variation within the groups. The between-group variation is in the numerator to calculate F, while the within-group variation is in the denominator.

> Subtracting the grand mean from the group mean results in the difference between the group and the overall sample. The difference between the grand mean and the group mean can be positive or negative and so is squared for the sum to more accurately represent the total of the differences. This squared value is then multiplied by nj or the number of people in the group and divided by k – 1, where k is the number of groups. This results in a numerator that quantifies the difference between the group means and grand mean for all the participants in the sample.

> The denominator sums the squared difference between each individual observation yij and the mean of the individual’s group, quantifying how far the individuals in the group are from the mean of the group. This is divided by the number of individuals in the whole sample minus the number of groups.


:::::{.my-theorem}
:::{.my-theorem-header}
:::::: {#thm-chap07-f-statistic}
: F-Statistic
::::::
:::
::::{.my-theorem-container}

$$
\begin{align*}
F &= \frac{\text{between-group variability}}{\text{within-group variability}} \\
&= \frac{\text{explained variance}}{\text{unexplained variance}} \\
&= \frac{s_{between}^2}{s_{within}^2}
\end{align*}
$$ {#eq-chap07-f-statistic}

***

> The F-statistic, then, could be referred to as a ratio of explained to unexplained variance. That is, how much of the variability in the outcome does the model explain compared to how much it leaves unexplained? The larger the F-statistic, the more the model has explained compared to what it has left unexplained.

> The F-statistic can also be represented as the ratio of the variance between the groups to the variance within the groups.

::::
:::::

### Computing F-test for using technology at the work place

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-f-test}
: F-test for using technology at the work place
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### F-test

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-f-test-usetech-degree}
: Applying F-test `stats::oneway.test()`
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: tbl-f-test-usetech-degree
#| tbl-cap: "Applying F-test statistic (ANOVA)"

gss_2018_clean <- base::readRDS("data/chap07/gss_2018_clean.rds")

stats::oneway.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean,
    var.equal = TRUE
)


```

::::
:::::


###### grand & group means

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-replicate-figure7-5}
: Distribution of work time spent using technology by educational attainment, with grand mean and group means (Replication of book Figure 7.5)
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: techuse-dist-grand-mean
#| fig-cap: "Distribution of work time spent using technology by educational attainment, with grand mean and group means"
#| results: hold

grand_mean <- 
    base::mean(gss_2018_clean$USETECH, na.rm = TRUE)

group_means <- gss_2018_clean |> 
    tidyr::drop_na(USETECH, DEGREE) |> 
    dplyr::group_by(DEGREE) |> 
    dplyr::summarize(mean = mean(USETECH))

gg3_gss_2018 <- gss_2018_clean |> 
  tidyr::drop_na(USETECH) |> 
  ggplot2::ggplot(
      ggplot2::aes(
          x = DEGREE,
          y = USETECH
          )
      ) +
  ggplot2::geom_jitter(
      ggplot2::aes(
          alpha = .6
      ),
      color = "darkgrey"
  ) +
  ggplot2::geom_hline(
      ggplot2::aes(
          yintercept = grand_mean,
          linetype = "solid"
      ),
      color = "steelblue",
      linewidth = 1
  ) +
  ggplot2::geom_point(
      data = group_means,
      ggplot2::aes(
          x = DEGREE,
          y = mean,
          size = 3
      ),
      color = "purple4",
      inherit.aes = FALSE
  ) +
  ggplot2::theme_bw() +
  ggplot2::labs(
      x = "Highest educational attainment", 
      y = "Percent of time spent using technology"
  ) +
  ggplot2::scale_size_continuous(
      name = "",
      labels = "Group mean"
  ) +
  ggplot2::scale_linetype_discrete(
      name = "",
      labels = "Grand mean"
  ) +
  ggplot2::scale_alpha_continuous(
      name = "",
      labels = "Observation"
  )

gg3_gss_2018
```

***
This R-Code junk replicates book’s Figure 7.5, which has no accompanying R code.

> For each group, the group mean does a better job than the `r glossary("grand", "overall mean")` of explaining tech use *for that group*. The difference between the group mean and the overall mean is *how much better* the group mean is at representing the data in the group. This difference is used to compute the numerator of the `r glossary("F-statistic")`.
::::
:::::

###### F-distributions

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-f-dist-examples}
: F-distribution examples
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-f-dist-examples
#| fig-cap: "F-distribution examples"

ggplot2::ggplot(
    tibble::tibble(x = c(0, 5)), 
    ggplot2::aes(x = x,
                 color = "text")
    ) +
    ggplot2::stat_function(fun = df, 
                           args = list(df1 = 4, df2 = 2000), 
                           ggplot2::aes(color = "4, 2000"),
                           linewidth = .7) +
    ggplot2::stat_function(fun = df, 
                           args = list(df1 = 4, df2 = 25), 
                           ggplot2::aes(color = "4, 25"),
                           linewidth = .7) +
    ggplot2::stat_function(fun = df, 
                           args = list(df1 = 2, df2 = 2000), 
                           ggplot2::aes(color = "2, 2000"),
                           linewidth = .7) +
    ggplot2::stat_function(fun = df, 
                           args = list(df1 = 2, df2 = 25), 
                           ggplot2::aes(color = "2, 25"),
                           linewidth = .7) +
    ggplot2::scale_color_manual(
        name = "Degress of freedom\n(num, denom)",
        values = c("purple4", "purple", "green", "seagreen"),
        breaks = c("4, 2000","4, 25","2, 2000", "2, 25")
    )

```

::::
:::::

###### Technology use (ANOVA)

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-f-statistic-tech-use}
: F-distribution for the technology use by degree ANOVA (df = 4 and 1404)
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-f-statistic-tech-use
#| fig-cap: "F-distribution for the technology use by degree ANOVA (df = 4 and 1404)"

ggplot2::ggplot(
    tibble::tibble(x = c(0, 5)), 
    ggplot2::aes(x = x)
    ) +
    ggplot2::stat_function(fun = df, 
                           args = list(df1 = 4, df2 = 1404), 
                           linewidth = .7)
```
***

> The F-distribution in @fig-f-statistic-tech-use suggested the F-statistic of 43.30 was far to the right in the tail of the distribution. The probability of an F-statistic this large or larger if the null were true was reported in the output as < 2.2e-16, which is < .001. With a p-value this tiny, the F-statistic would be considered statistically significant.



::::
:::::


:::

::::
:::::

::: {.callout-tip}
> The mean time spent on technology use was significantly different across degree groups [F(4, 1404) = 43.3; p < .05], indicating that these groups likely came from a population with different mean time spent on technology use by educational attainment. The highest mean was the percent of time used for technology by those with graduate degrees. The lowest mean was the percent of time used for technology by those with less than a high school diploma.
:::


## Achievement 3: Post hoc tests & contrasts {#sec-chap07-achievement3}

`r glossary("ANOVA")` is --- similar as the `r glossary("chi-squared", "chi-squared test")` --- an `r glossary("omnibus")` test: iIt identifies whether there are any differences, but doesn’t give any information about what is driving the significant results.

There are two main ways to determine where significant differences among groups are following a significant omnibus test:

- **Post hoc tests**: Examining each pair of means to determine which means are the most different from each other.
- **Planned contrasts**: Comparing specified subsets of means or groups of means.

### Post hoc tests

#### Bonferroni

There are several different types of post hoc tests, and one of the more commonly used is the `r glossary("Bonferroni", "Bonferroni post hoc test")`.

The Bonferroni adjustment multiplies each `r glossary("p-value")` from each `r glossary("t-test")` by the overall number of t-tests conducted. There were 10 pairwise comparisons (5 groups each pairwise = 5 * 2), so these p-values have been multiplied by 10. Higher p-values will not reach the threshold for statistical significance as often. Sometimes there are resulting p-values of 1.0000. As the p-value cannot be over 1, so for p-values that are over 1 when adjusted by the multiplication, they are rounded to exactly 1.0000.

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-bonferroni-test}
: Bonferroni post hoc test
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: bonferroni-test

stats::pairwise.t.test(
    x = gss_2018_clean$USETECH,
    g = gss_2018_clean$DEGREE,
    p.adjust.method = "bonferroni"
)

```
***

The output is different from previous statistical testing. Instead of a test statistic like t or F, the output is a matrix of p-values.

The adjusted p-values for seven of the t-tests fall below .05 and so indicate that the difference in mean time using technology between two groups is statistically significant.

- There are significant differences in mean time between less than high school and all of the other groups (p < .05); 
- Likewise, there are significant differences in mean time using technology between high school and all other groups. 
- There are no significant differences among the means of the three college groups (junior college, bachelor, graduate).


::::
:::::

For the report it would be more informative if one could add the group means for the interpretation:

```{r}
#| label: group-means-usetech-degree

gss_2018_clean |> 
    tidyr::drop_na(USETECH, DEGREE) |> 
    dplyr::group_by(DEGREE) |> 
    dplyr::summarize(
        group_means = base::round(base::mean(USETECH), 1)
    )
```

::: {.callout-tip}
> Mean percentage of time using technology at work was statistically significantly (p < .05) lower for people with less educational attainment than a high school diploma (m = 24.8) compared to each of the other groups, where the mean percentage of time using technology ranged from 49.6 to 68.7.
:::

#### Tukey’s Honestly Significance Difference (HSD)

Tukey’s HSD post hoc test is a modified `r glossary("t-test")` with the test statistic, `q`. The `q` test statistic formula is the same as some versions of `t`, but the q-distribution is different from the t-distribution, raising the critical value necessary to reach statistical significance. Even with the same test statistic, it is more difficult to reach statistical significance with a Tukey’s `r glossary("HSD")` q-statistic compared to a t-test.

$$
q = \frac{m_{1} - m_{2}}{se}
$$ {#eq-chap07-hsd}

The `stats::TukeyHSD()` function does not work well with the `stats::oneway.test()` output from earlier, so the entire ANOVA model has to be re-estimated. The `stats:aov()` function works and takes similar arguments to the `stats::oneway.test()` function, so nesting the `stats::aov()` inside the `stats::TukeyHSD()` is one way to go.

:::::{.my-important}
:::{.my-important-header}
Difference between test and fitting a model
:::
::::{.my-important-container}
After my first reading it wasn’t quite clear for me what the difference is between `stats::oneway.test()` and `stats::aov()`. 

Later --- when I worked on the two-way ANOVA in @sec-chap07-achievement7 --- I learned that the first approach is a test whereas the second functions fits a model by a call to `lm()`. To get the full data for testing if the data are statistically significant one has to wrap `stats::aov()` into to the `base::summary()` function. 

***


```{r}
#| label: anova-test-vs-fitting-model
#| results: hold

gss_2018_clean <- base::readRDS("data/chap07/gss_2018_clean.rds")

glue::glue("##################  oneway.test()    ####################")
stats::oneway.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean,
    var.equal = TRUE
)

glue::glue(" ")
glue::glue("######################  aov()    ##########################")
glue::glue(" ")
stats::aov(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)

glue::glue(" ")
glue::glue("##################  summary(aov())    ####################")
glue::glue(" ")
base::summary(
    stats::aov(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
    )
)

```

::::
:::::


:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-hsd}
: Compute Tukey’s Honestly Significance Difference (HSD)
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: chap07-hsd

stats::TukeyHSD(
    stats::aov(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
    )
)

```

The number of significant results of the 10 test are the same, although the Bonferroni test is more conservative. For example the p-value of the pairwise test between junior college and bachelor are 0.58 in HSD but 1.0 in Bonferroni.

::::
:::::

::: {.callout-tip}
The mean time spent on technology use was significantly different across education groups [F(4, 1404) = 43.3; p < .05], indicating that these groups likely came from a population with different mean time spent on technology use depending on educational attainment. The highest mean was 68.7% of time used for technology for those with graduate degrees. The lowest mean was 24.8% of the time for those with less than a high school diploma. Mean percentage of time using technology was statistically significantly (p < .05) *lower* for people with less than a high school diploma (m = 24.8) compared to each of the other groups where the mean percentage of time using technology ranged from 49.6 to 68.7.
:::


### Planned comparisons

#### Introduction

`r glossary("Planned comparisons")` are computed by developing `r glossary("contrasts")` that specify which means to compare to which other means.

::: {#bul-planned-contrasts}
:::::{.my-bullet-list}
:::{.my-bullet-list-header}
Bullet List
:::
::::{.my-bullet-list-container}


- The order of the factor variable is the exact order that should be used in the contrast.
- A contrast is a group of numbers used to group categories. 
- The categories grouped together should all be represented by the same number in the contrast. 
- The numbers in the contrast should all add to zero. 
- Any category not included in the contrast should be represented by a zero.

::::
:::::
Rules for planned contrasts 
:::

***

For example, to compare all the college groups to the high school group, the contrast would omit the less than high school group and compare the mean for everyone in the high school group to the mean of the combined three college groups: junior college, bachelor, and graduate.

- 0 (< high school: do not include) 
- 3 (high school) 
- –1 (junior college) 
- –1 (bachelor) 
- –1 (graduate)

The three categories represented by –1 will be grouped together because they are all represented by the same number.

#### Compute planned contrasts

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-planned-constrasts}
: Planned contrasts of using technology by degree
::::::
:::
::::{.my-example-container}


::: {.panel-tabset}

###### high school & colleges

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-contrast-high-school-colleges}
: Planned contrasts of using technology for the college groups to high school group
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: contrast-high-school-colleges
#| results: hold

## 1. put the contrast into a vector
contrast1 <- c(0, 3, -1, -1, -1)

## 2. link the contrast to the categorical variable using contrasts()
stats::contrasts(x = gss_2018_clean$DEGREE) <- contrast1

## 2a. view the structure of the DEGREE variable with contrast
glue::glue("************** View the structure of DEGREE variable *****************")
utils::str(object = gss_2018_clean$DEGREE)

## 3. re-run the model using aov()
usetech_degree_aov <- stats::aov(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)

## 4. apply the contrasts to the aov object
glue::glue(" ")
glue::glue("******************* Summarize the aov object ****************************")
stats::summary.aov(
    object = usetech_degree_aov,
    split = list(DEGREE = 
            list("high school vs. all college" = 1)))

```

***

The output showed that mean technology use for those who finished high school was statistically significantly different from mean technology use for the three college groups combined [F(1, 1404) = 50.41; p < .001].

To understand more of what was happening we need to lookat the means being compared with this contrast.

::::
:::::


###### recode high school & colleges

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-contrast-no-high-school-colleges}
: Using technology for the recoded planned contrast between college groups to high school group
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: contrast-no-high-school-colleges

gss_2018_clean |> 
    dplyr::mutate(DEGREE =
          forcats::fct_collapse(DEGREE,
                `all college` = c(
                    "junior college",
                    "bachelor",
                    "graduate"
                    ) 
                )
          ) |> 
    dplyr::group_by(DEGREE) |> 
    dplyr::summarize(mean_usetech = mean(USETECH, na.rm = TRUE),
                     sd_usetech = sd(USETECH, na.rm = TRUE))
```
***

I have used here the first time the `forcats::fct_collaps()` function. This is more understandable as the option in the book, where (a) all factors are recoded and the thre highest factors with the same name "all college".

The difference between the mean technology use time for high school (m = 49.61) compared to all college groups combined (m = 66.97) is pretty large.

::::
:::::

###### Plot hs & colleges

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-graph-contrast-no-high-school-colleges}
: Plot of using technology for the recoded planned contrast between college groups to high school group
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-graph-contrast-no-high-school-colleges
#| fig-cap: "Contrast between time using technology for the high school group to the three college groups (junior college, beachelor, graduate)"

gss_2018_clean |> 
    dplyr::mutate(DEGREE =
          forcats::fct_collapse(DEGREE,
                `all college` = c(
                    "junior college",
                    "bachelor",
                    "graduate"
                    ) 
                )
          ) |> 
    dplyr::filter(DEGREE == "high school" | DEGREE == "all college") |> 
    
    ggplot2::ggplot(
        ggplot2::aes(
            y = USETECH, 
            x = DEGREE, 
            fill = DEGREE, 
            color = DEGREE
        )
    ) +
    ggplot2::geom_boxplot(
        alpha = .4,
        na.rm = TRUE
        ) + 
    ggplot2::geom_jitter(
        alpha = .6,
        na.rm = TRUE
        ) + 
    ggplot2::scale_fill_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::scale_color_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::labs(
        x = "Educational attainment", 
        y = "Percent of time spent using technology"
        )
```
***
It is clear that the means of these two groups are different. The same probably would also be true for the less than high school group with the three college groups.
::::
:::::

###### < hs to colleges

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-contrast-less-hs-colleges}
: Planned contrasts of time using technology on the job between college groups to less than high school group
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: contrast-less-hs-colleges
#| results: hold

## 1. less than high school v. all college contrast
contrast2 <- base::c(3, 0, -1, -1, -1)

## 2. bind the two contrasts together (matrix required!)
my_contrasts <- 
    as.matrix(dplyr::bind_cols(
        contrast1 = contrast1, 
        contrast2 = contrast2))

## 3. connect the tibble with factor variable
stats::contrasts(gss_2018_clean$DEGREE) <-  my_contrasts

## 4. compute ANOVA with planned contrasts
stats::summary.aov(
    object = usetech_degree_aov,
    split = list(DEGREE = 
            list("high school vs. all college" = 1,
                 "< high school vs. all college" = 2)
            )
    )
```

::::
:::::

###### plot < hs & colleges

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-graph-less-than-hs-all-colleges}
: Plot of using technology for the recoded planned contrast between college groups to less than high school group
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-graph-less-than-hs-all-colleges
#| fig-cap: "Distribution of tech use at work by degree for contrast comparing all college groups combined to each of the other groups"

gss_2018_clean |> 
    dplyr::mutate(DEGREE =
          forcats::fct_collapse(DEGREE,
                `all college` = c(
                    "junior college",
                    "bachelor",
                    "graduate"
                    ) 
                )
          ) |> 
    
    ggplot2::ggplot(
        ggplot2::aes(
            x = DEGREE, 
            y = USETECH, 
            fill = DEGREE, 
            color = DEGREE
        )
    ) +
    ggplot2::geom_boxplot(
        alpha = .4,
        na.rm = TRUE
        ) + 
    ggplot2::geom_jitter(
        alpha = .6,
        na.rm = TRUE
        ) + 
    ggplot2::scale_fill_manual(
        values = c("gray70", "#7463AC", "dodgerblue"), 
        guide = "none"
        ) + 
    ggplot2::scale_color_manual(
        values = c("gray70", "#7463AC", "dodgerblue"), 
        guide = "none"
        ) + 
    ggplot2::labs(
        x = "Educational attainment", 
        y = "Percent of time spent using technology"
        )

```

::::
:::::

###### 4 contrasts

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-4-contrasts}
: Four planned comparisons
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: chap07-4-contrasts

## contrasts for ANOVA of tech time by degree 
c1 <- c(2, -1, -1, 0, 0) 
c2 <- c(0, 3, -1, -1, -1) 
c3 <- c(0, 0, 2, -1, -1) 
c4 <- c(0, 0, 0, -1, 1) 

## bind the contrasts into a matrix 
conts <- cbind(c1, c2, c3, c4) 
conts

```

***

:::::{.my-procedure}
:::{.my-procedure-header}
:::::: {#prp-chap07-check-contrasts}
: Check the values of the contrasts
::::::
:::
::::{.my-procedure-container}
1. Add up each contrast to make sure it adds to zero. 
2. Multiply each value in each contrast with the corresponding values in the other contrasts and add up the products; this should also add to zero.
::::
:::::

**ad 1**: The vectors are now columns. An example of a check is to sum the column c1: $2 + (-1) + (-1) + 0 + 0 = 0$. Columns c2, c3 and c4 also result to $0$. So the first check conditions was passed.

**ad 2**: Now we have to multiply the values row-wise: $2 \times 0 \times 0 \times 0 = 0$ It is easy to check: Whenever there is $0$ in one of the columns then the result is also $0$. Adding all these products together results in $0 + 0 + 0 + 0 + 0 = 0$, so the second requirement is also met.

::::
:::::

###### `aov()` 4 contrasts

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-aov-4-contrasts}
: Conncet the matrix with all levels of the factor variable
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: chap07-aov-4-contrasts

## connect the matrix with the factor variable 
stats::contrasts(x = gss_2018_clean$DEGREE) <- conts 

## estimate the ANOVA with 4 independent contrasts 
usetech_degree_4_contrasts <- 
    summary.aov(object = usetech_degree_aov, 
        split = list(DEGREE = 
             list("< high school vs. high school & jr college" = 1, 
                  "high school vs. all college" = 2, 
                  "jr college vs. bach or grad degree" = 3, 
                  "bachelor’s vs. graduate degree" = 4)
             )
        ) 
usetech_degree_4_contrasts
```


::::
:::::

###### Adjust p-values

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-adjust-p-values}
: Adjust p-values for multiple comparisons
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: adjust-p-values

adj_p_values <- stats::p.adjust(
    p = usetech_degree_4_contrasts[[1]][["Pr(>F)"]], 
    method = "bonferroni"
    )
adj_p_values
```
***

The adjusted p-values were still very small, so the conclusions about statistical significance did not change, even when using a conservative adjustment like `r glossary("Bonferroni")`.

::::
:::::

###### Violin plot

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-4-planned-comp-violin-plot}
: Visualizing the distribution of technology use at work by educational attainment for four planned comparisons
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-4-planned-comp-violin-plot
#| fig-cap: "Visualizing the distribution of technology use at work by educational attainment for four planned comparisons (violin plot)"
#| fig-height: 10
#| results: hold
#| cache: true

## < high school / hs & jr college ########
gg_violin1 <- gss_2018_clean |>
  dplyr::mutate(DEGREE = 
        dplyr::if_else(DEGREE == "< high school", "< high school",
        dplyr::if_else(DEGREE %in% c("high school", 
                                     "junior college"),
                                     "high school & jr college",
                                     NA))) |>
  dplyr::mutate(DEGREE = 
         base::factor(DEGREE, levels = c("< high school",
                                         "high school & jr college"),
                                         ordered = T)) |>
  dplyr::filter(DEGREE == "< high school" | 
                DEGREE == "high school & jr college") |> 

      ggplot2::ggplot(
        ggplot2::aes(
            y = USETECH, 
            x = DEGREE, 
            fill = DEGREE, 
            color = DEGREE
        )
    ) +
    ggplot2::geom_violin(
        alpha = .4,
        na.rm = TRUE
        ) + 
    ggplot2::geom_jitter(
        alpha = .6,
        na.rm = TRUE
        ) + 
    ggplot2::scale_fill_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::scale_color_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::labs(
        x = "Educational attainment", 
        y = "Percent of time spent using technology"
        )
    
    
## high school & three college groups##########
gg_violin2 <- gss_2018_clean |> 
    dplyr::mutate(DEGREE =
          forcats::fct_collapse(DEGREE,
                `all college` = c(
                    "junior college",
                    "bachelor",
                    "graduate"
                    ) 
                )
          ) |> 
    dplyr::filter(DEGREE == "high school" | DEGREE == "all college") |>
    ggplot2::ggplot(
        ggplot2::aes(
            y = USETECH, 
            x = DEGREE, 
            fill = DEGREE, 
            color = DEGREE
        )
    ) +
    ggplot2::geom_violin(
        alpha = .4,
        na.rm = TRUE
        ) + 
    ggplot2::geom_jitter(
        alpha = .6,
        na.rm = TRUE
        ) + 
    ggplot2::scale_fill_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::scale_color_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::labs(
        x = "Educational attainment", 
        y = "Percent of time spent using technology"
        )

## jr college & bachelor & graduate ##########
gg_violin3 <- gss_2018_clean |> 
    dplyr::mutate(DEGREE = 
    dplyr::if_else(DEGREE %in% c("< high school", "high school"), NA,
    dplyr::if_else(DEGREE == "junior college", "jr college",
    dplyr::if_else(DEGREE %in% c("bachelor", "graduate"),
                                 "bachelor or graduate", NA)))) |>
    dplyr::mutate(DEGREE = 
      base::factor(DEGREE, 
                   levels = c("jr college", 
                              "bachelor or graduate", 
                              ordered = T))) |>
    dplyr::filter(DEGREE == "jr college" | DEGREE == "bachelor or graduate") |>
    
    ggplot2::ggplot(
        ggplot2::aes(
            y = USETECH, 
            x = DEGREE, 
            fill = DEGREE, 
            color = DEGREE
        )
    ) +
    ggplot2::geom_violin(
        alpha = .4,
        na.rm = TRUE
        ) + 
    ggplot2::geom_jitter(
        alpha = .6,
        na.rm = TRUE
        ) + 
    ggplot2::scale_fill_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::scale_color_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::labs(
        x = "Educational attainment", 
        y = "Percent of time spent using technology"
        )

## bachelor & graduate ############
gg_violin4 <- gss_2018_clean |> 
    dplyr::mutate(DEGREE = 
        dplyr::if_else(DEGREE == "bachelor", "bachelor",
        dplyr::if_else(DEGREE == "graduate", "graduate", NA))) |>
      dplyr::mutate(DEGREE = 
        base::factor(DEGREE, 
                     levels = c("bachelor", 
                                "graduate", 
                                ordered = T))) |>
    dplyr::filter(DEGREE == "bachelor" | DEGREE == "graduate") |> 

    ggplot2::ggplot(
        ggplot2::aes(
            y = USETECH, 
            x = DEGREE, 
            fill = DEGREE, 
            color = DEGREE
        )
    ) +
    ggplot2::geom_violin(
        alpha = .4,
        na.rm = TRUE
        ) + 
    ggplot2::geom_jitter(
        alpha = .6,
        na.rm = TRUE
        ) + 
    ggplot2::scale_fill_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::scale_color_manual(
        values = c("gray70", "#7463AC"), 
        guide = "none"
        ) + 
    ggplot2::labs(
        x = "Educational attainment", 
        y = "Percent of time spent using technology"
        )

gridExtra::grid.arrange(
    gg_violin1, gg_violin2,
    gg_violin3, gg_violin4,
    ncol = 2)
```

***
This is the replication of book’s Figure 7.10.
::::
:::::

###### Contrasts statistic

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-planned-comp-contrasts-statistic}
: Summary of the constrasts statistic
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: planned-comp-contrast-statistic
#| cache: true
#| results: hold



## contrast 1 statistics ###########
glue::glue(" ")
glue::glue("#################### contrast 1 statistics ###################")
gss_2018_clean  |> 
  dplyr::mutate(DEGREE = 
        dplyr::if_else(DEGREE == "< high school", "< high school",
        dplyr::if_else(DEGREE %in% c("high school", 
                                     "junior college"),
                                     "high school & jr college",
                                     NA))) |>
  dplyr::mutate(DEGREE = 
         base::factor(DEGREE, levels = c("< high school",
                                         "high school & jr college"),
                                         ordered = T)) |>
  dplyr::group_by(DEGREE) |>
  dplyr::summarise(
      mean_usetech = base::mean(x = USETECH, na.rm = T),
      sd_usetech = stats::sd(x = USETECH, na.rm = T))



## contrast 2 statistics ##############
glue::glue(" ")
glue::glue("#################### contrast 2 statistics ###################")
gss_2018_clean |>
  dplyr::mutate(DEGREE = 
         base::factor(DEGREE, labels = c(NA,
               "high school", "all college",
               "all college", "all college"),
               ordered = T)) |>
  dplyr::group_by(DEGREE) |>
  dplyr::summarise(
      mean_usetech = mean(x = USETECH, na.rm = T),
      sd.usetech = sd(x = USETECH, na.rm = T)) 

## contrast 3 statistics ##############
glue::glue(" ")
glue::glue("#################### contrast 3 statistics ###################")
gss_2018_clean |>
  dplyr::mutate(DEGREE = 
    dplyr::if_else(DEGREE %in% c("< high school", "high school"), NA,
    dplyr::if_else(DEGREE == "junior college", "jr college",
    dplyr::if_else(DEGREE %in% c("bachelor", "graduate"),
                                 "bach or grad degree", NA)))) |>
    dplyr::mutate(DEGREE = 
      base::factor(DEGREE, 
                   levels = c("jr college", 
                              "bach or grad degree", 
                              ordered = T))) |>
  dplyr::group_by(DEGREE) |>
  dplyr::summarise(
      mean_usetech = mean(x = USETECH, na.rm = T),
      sd.usetech = sd(x = USETECH, na.rm = T))

# contrast 4 statistics ####################
glue::glue(" ")
glue::glue("#################### contrast 4 statistics ###################")
gss_2018_clean |>
  dplyr::mutate(DEGREE = 
    dplyr::if_else(DEGREE == "bachelor", "bachelor",
    dplyr::if_else(DEGREE == "graduate", "graduate", NA))) |>
  dplyr::mutate(DEGREE = 
    base::factor(DEGREE, 
                 levels = c("bachelor", 
                            "graduate", 
                            ordered = T))) |>
  dplyr::group_by(DEGREE) |>
  dplyr::summarise(
     mean_usetech = mean(x = USETECH, na.rm = T),
     sd_usetech = sd(x = USETECH, na.rm = T))

```

::::
:::::




:::

::::
:::::

::: {.callout-tip}
The mean time spent on technology use at work was significantly different across educational attainment groups [F(4, 1404) = 43.3; p < .05], indicating these groups likely came from populations with different mean time spent on technology use. The highest mean was percent of time used for technology for those with graduate degrees. The lowest mean was percent of time for those with less than a high school diploma. A set of planned comparisons found that the mean time spent using technology was statistically significantly (p < .05) lower for (a) those with < high school education (m = 24.8) compared to those with high school or junior college (m = 51.7), (b) those with a high school education (m = 49.61) compared to those with all college groups combined (m = 67.0), (c) those with a junior college degree (m = 62.4) compared to those with a bachelor’s or graduate degree (m = 68.2), and (d) those with a bachelor’s degree (m = 67.9) compared to those with a graduate degree (m = 68.7). Overall, the patterns show statistically significant increases in time spent using technology at work for those with more education.
:::

How many contrasts could be done and how all these statistical comparisons might be inflating the Type I error? --- In addition to each comparison comparing two things and each comparison adding to zero, the planned comparisons as a group should isolate each group (e.g., the high school group) *only one time*. This ensures that the contrasts are independent of each other since the variance for each group is only used by itself in a statistical comparison one time. Because each group is isolated one time, the total maximum number of contrasts allowable is one less than the number of groups.

> When you have hypotheses ahead of time about which groups are different from one another, use `r glossary("planned comparisons")`. When you do not have hypotheses ahead of time about which means are different from each other, use post hoc tests if the ANOVA has a statistically significant `r glossary("F-statistic")`. Good research practices suggest that having hypotheses ahead of time is a stronger strategy unless the research is truly exploratory.

::: {#bul-characeristic-contrast}
:::::{.my-bullet-list}
:::{.my-bullet-list-header}
Bullet List
:::
::::{.my-bullet-list-container}


- Contrast values add to zero. 
- Each contrast compares two groups. 
- Each category is only isolated one time. 
- The maximum number of contrasts is one less than the number of categories.

::::
:::::
Characteristics of contrasts

:::

***

## Achievement 4: Effect sizes for ANOVA {#sec-chap07-achievement4}

Similar as the effect size `r glossary("Cramér’s V")` for `r glossary("chi-squared")` tests and `r glossary("Cohen’s d")` for t-test, there are also effect size indices for ANOVA:

- **`r glossary("eta-squared")`**: It has a positive bias
- **`r glossary("omega-squared")`**: An unbiased modern alternative

:::::{.my-theorem}
:::{.my-theorem-header}
:::::: {#thm-chap07-omega-squared}
: Formula for omega-squared
::::::
:::
::::{.my-theorem-container}
$$
\omega^2 = \frac{F - 1}{f + \frac{n-k+1}{k-1}}
$$ {#eq-chap07-omega-squared}

- **F**: Statistics from the ANOVA result
- **n**: Number of observations
- **k**: Number of groups

::::
:::::



:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-omega-squared-manual}
: Manual computation of effect size omega-squared
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: omega-squared-manual
#| results: hold

gss_2018_clean <- base::readRDS("data/chap07/gss_2018_clean.rds")

usetech_degree_aov <- stats::aov(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)

glue::glue("############# ANOVA model USETECH ~ DEGREE ##################")
(
    usetech_degree_aov_summary <- base::summary(usetech_degree_aov)
)

F_value = usetech_degree_aov_summary[[1]][["F value"]][[1]]
n = base::nrow(usetech_degree_aov[["model"]])
k = usetech_degree_aov[["rank"]]


glue::glue(" ")
glue::glue("############# Omega-squared ##################")
omega_squared <- (F_value - 1) / (F_value + ((n - k + 1) / (k - 1)))
omega_squared
```
***

:::::{.my-watch-out}
:::{.my-watch-out-header}
WATCH OUT! Error in the book’s calculation
:::
::::{.my-watch-out-container}
In the first term in the book `-1` is missing! The formula is `F-1` that should be therefore `(summ.tech.anova[[1]][1, 4] -1)`. 

With this correction we get the same value as in the manual calculation: `r omega_squared`.
::::
:::::

::::
:::::

:::::{.my-assessment}
:::{.my-assessment-header}
:::::: {#cor-chap07-omega-squared}
: Interpretation of omega-squared effect size
::::::
:::
::::{.my-assessment-container}

- **Small**: $\omega^2 = .01 \text{ to } \omega^2 < .06$
- **Medium**: $\omega^2 = .06 \text{ to } \omega^2 < .14$
- **Large**: $\omega^2 ≥ .14$

***
This is quite similar to the eta_squared ($\eta^2$) assessment as listed in [Computation of Effect Sizes](https://www.psychometrica.de/effect_size.html). 

::::
:::::

::: {.callout-tip}
The mean time spent on technology use at work was significantly different across educational attainment groups [F(4, 1404) = 43.3; p < .05], indicating these groups likely came from populations with different mean time spent on technology use. The highest mean was percent of time used for technology for those with graduate degrees. The lowest mean was percent of time for those with less than a high school diploma. A set of planned comparisons found that the mean time spent using technology was statistically significantly (p < .05) lower for (a) those with < high school education (m = 24.8) compared to those with high school or junior college (m = 51.7), (b) those with a high school education (m = 49.61) compared to those with all college groups combined (m = 67.0), (c) those with a junior college degree (m = 62.4) compared to those with a bachelor’s or graduate degree (m = 68.2), and (d) those with a bachelor’s degree (m = 67.9) compared to those with a graduate degree (m = 68.7). Overall, the patterns show statistically significant increases in time spent using technology at work for those with more education. The strength of the relationship between degree and time using technology at work was medium ($ω^2$ = .11).
:::

## Achievement 5: Testing ANOVA assumptions {#sec-chap07-achievement5}

0. **Continuous variable and independent groups**: This is the prerequisite for ANOVA.
1. **Normality**: Each sample was drawn from a normally distributed population.
2. **Equal Variances**: The variances of the populations that the samples come from are equal.
3. **Independence**: The observations in each group are independent of each other and the observations within groups were obtained by a random sample.

### Testing normality

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-testing-normality}
: Testing normality
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### Density plot

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-normality-density-plot}
: Testing normality with density plots
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-testing-normality-density-plot
#| fig-cap: "Density Plot: Testing normality of time spent with technology at the job diferentiated by highest educational attainment"

gss_2018_clean |> 
    tidyr::drop_na(USETECH) |> 
    ggplot2::ggplot(
        ggplot2::aes(x = USETECH)
    ) +
    ggplot2::geom_density(
        ggplot2::aes(
            fill = DEGREE
        )
    ) +
    ggplot2::facet_wrap(
        facets = ggplot2::vars(DEGREE),
        nrow = 2
    ) +
    ggokabeito::scale_fill_okabe_ito(guide = "none") +
    ggplot2::labs(
        x = "Percent of time using tech", 
        y = "Probability density")
```
***

None of these graphs looks normally distributed!
::::
:::::

###### Q-Q plot small

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-normality-qq-plot1}
: Testing normality with Q-Q plots
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-testing-normality-qq-plot1
#| fig-cap: "Q-Q Plot: Testing normality of time spent with technology at the job diferentiated by highest educational attainment"
#| cache: true

gss_2018_clean  |> 
  tidyr::drop_na(USETECH) |>
  
  ggplot2::ggplot(
      ggplot2::aes(sample = USETECH)
      ) +
  ggplot2::geom_abline(
      ggplot2::aes(
          intercept = mean(USETECH), 
          slope = sd(USETECH), 
          linetype = "Normally distributed"),
          color = "gray60", 
          linewidth = 1
      ) +
  ggplot2::stat_qq(
      ggplot2::aes(color = DEGREE)
      ) +
  ggokabeito::scale_color_okabe_ito(guide = "none") +
  ggplot2::scale_linetype_manual(
      name = "",
      values = 1) +
  ggplot2::labs(
      x = "Theoretical normal distribution",
      y = "Observed values of percent time using tech"
      ) +
  ggplot2::facet_wrap(
      facets = ggplot2::vars(DEGREE), 
      nrow = 2
      )
```

***

The text in the books says that "none of the groups appeared to be normally distributed based on either type of plot." This is ok for me with the density plot. But for me with not so much experience it is difficult to decide with the small Q-Q plots.

The next tab display the Q-Q plots for each group much bigger.

::::
:::::

###### Q-Q plot big

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-normality-qq-plot2}
: Testing normality with Q-Q plots
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-testing-normality-qq-plot2
#| fig-cap: "Q-Q Plot: Testing normality of time spent with technology at the job diferentiated by highest educational attainment"
#| fig-height: 12
#| cache: true

gss_2018_clean  |> 
  tidyr::drop_na(USETECH) |>
  
  ggplot2::ggplot(
      ggplot2::aes(sample = USETECH)
      ) +
  ggplot2::geom_abline(
      ggplot2::aes(
          intercept = mean(USETECH), 
          slope = sd(USETECH), 
          linetype = "Normally distributed"),
          color = "gray60", 
          linewidth = 1
      ) +
  ggplot2::stat_qq(
      ggplot2::aes(color = DEGREE)
      ) +
  ggokabeito::scale_color_okabe_ito(guide = "none") +
  ggplot2::scale_linetype_manual(
      name = "",
      values = 1) +
  ggplot2::theme(legend.position = "top") +
  ggplot2::labs(
      x = "Theoretical normal distribution",
      y = "Observed values of percent time using tech"
      ) +
  ggplot2::facet_wrap(
      facets = ggplot2::vars(DEGREE), 
      nrow = 5
      )
```
***

Now I can see it very clearly: All groups are not normally distributed. One can also observe that the floor and ceiling values are driving some of the non-normality.
::::
:::::

###### Shapiro-Wilk test

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-normality-shapiro-wilk}
: Numbered R Code Title
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: testing-normality-shapiro-wilk
#| fig-cap: "Shapiro-Wilk: Testing normality of time spent with technology at the job diferentiated by highest educational attainment"
#| cache: true
#| results: hold

glue::glue("###### Test for the whole numeric USETECH vector #######")
stats::shapiro.test(gss_2018_clean$USETECH)

glue::glue(" ")
glue::glue("###### Test for DEGREE groups of USETECH vector #######")
gss_2018_clean |> 
    dplyr::select(USETECH, DEGREE) |> 
    tidyr::drop_na() |> 
    dplyr::group_by(DEGREE) |> 
    dplyr::summarize(
        shapiro_p_value = stats::shapiro.test(USETECH)$p.value
    )
```

***

In contrast with the systolic blood pressure data we have this time less than 5,000 observations and can therefore apply the `r glossary("Shapiro-Wilk", "Shapiro-Wilk test")`  (see @sec-chap06-omnibus-tests).

All five of the Shapiro-Wilk tests were statistically significant, indicating that the null hypothesis for this test (i.e., the data are normally distributed) has to be rejected for each group.
::::
:::::


:::

::::
:::::

### Testing homogeneity of variances

The data need to be not only normally distributed, but also spread out equally in each group, e.g. we need equal variances across groups.

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-homogeneity-levene-test}
: Levene’s test: Testing homogeneity of variances
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: testing-homogeneity-levene-test

car::leveneTest(
    y = USETECH ~ DEGREE, 
    data = gss_2018_clean, 
    center = mean)
```
***
The p-value for the Levene’s test suggests that we need to reject the null hypothesis. The variances of the `USETECH` variable are statistically significantly different across groups (p < .05). The ANOVA fails the assumption of homogeneity of variances.
::::
:::::

## Achievement 6: Alternative tests for ANOVA {#sec-chap07-achievement6}

### Homogeneity of variances failed

There are several tests available when the assumption of homogeneity fails. The book mentions two but there are others as well:

- **Brown-Forsythe F-statistic**: Manually with `stats::oneway.test()` and `onewaytests::bf.test()`
- **Welch Test**: `stats::oneway.test()` with `var.equal = FALSE`, and `onwaytests::welch.test()`, 
- **Levene's Homogeneity Test**: `car::leveneTest()` with `center = median` (default), `onewaytests::homog.test()` with `method = "Levene"`.
- **Bartlett Homogeneity Test**: `onewaytests::homog.test()` with `method = "Bartlett"`
- **Fligner-Killeen Homogeneity Test**: `onewaytests::homog.test()` with `method = "Fligner"`


#### Brown-Forsythe F-statistic

The `r glossary("Brown-Forsythe", "Brown-Forsythe F-statistic")` uses the distance each observation has from the median of the variable. The alternate `r glossary("F-statistic")` is then computed using the same F formula but with the means computed from the distance to the median instead using the raw values of the continuous variable.

:::::{.my-resource}
:::{.my-resource-header}
:::::: {#lem-chap07-brown-forsythe}
Packages for Brown-Forsythe F-statistic
::::::
:::
::::{.my-resource-container}
There are several packages with Brown-Forsythe F-statistic. Most of the explanations and examples in the internet propose {**onewaytests**}. Although this package has a low download figure under 100, I have added it to my package description in @sec-annex-a, because it includes many tests specialized for ANOVA with failed assumptions.

Instead of the Brown-Forsythe F-statistic one could also use `r glossary("Levene", "Levene’s test")` from the {**car**} packages with the argument `center = median`.

> Both Levene’s test and Brown-Forsythe test can be used for testing for homogeneity of variances on nonnormal data. But, the Brown-Forsythe test is more robust than Levene’s test when data distributions are skewed or heavy-tailed (Cauchy distribution). Brown-Forsythe test is a modified version of Levene’s test. ([Brown-Forsythe test for equality of variances in R](https://www.reneshbedre.com/blog/brown-forsythe-test-variance.html)) [@bedre2016].

The {**CGPfunctions**} can’t be downloaded from CRAN beginning with R version 4.0, but you could use the [GitHub version](https://github.com/ibecav/CGPfunctions) after you installed the {**pwr**} package. (See [issue #44](https://github.com/ibecav/CGPfunctions/issues/44)).

```{r}
#| label: tbl-donwload-numbers-brown-forsythe-packages
#| tbl-cap: "Download average numbers of packages with Brown-Forsythe tests" 
#| echo: false
#| cache: true

(cranlogs_brown_forsythe <- base::readRDS("data/chap07/cranlogs_brown_forsythe.rds"))

```

::::
:::::

#### Welch’s F-statistic

Welchs’s F-statistic is an alternate F-statistic used in analysis of variance when the assumption of homogeneity of variance is not met. The calculations for the Welch’s F-statistic use weights to calculate the group means and the grand mean.

Instead of using the complex formula it is better to use R functions.

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-testing-homogeneity-variances}
: Testing homogeneity of variances with different tests
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### Manual BF

**NHST Step 1**

Write the null and alternate hypotheses:

::: {.callout-note}
- **H0**: The mean value of the transformed technology use variable is the same across educational attainment groups.
- **HA**: The mean value of the transformed technology use variable is not the same across educational attainment groups.
:::

**NHST Step 2**

Compute the test statistic.

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-homogeneity-of-variances-bf-manually}
: Transform the outcome variable and use the `oneway.test()`
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: testing-homogeneity-of-variances-bf-manually
#| results: hold

gss_2018_clean <- base::readRDS("data/chap07/gss_2018_clean.rds")

gss_2018_clean2 <- gss_2018_clean |> 
    dplyr::group_by(DEGREE) |> 
    dplyr::mutate(
        usetech_tran = base::abs(USETECH - median(USETECH, na.rm = TRUE))
        ) |> 
    dplyr::ungroup()

save_data_file("chap07", gss_2018_clean2, "gss_2018_clean2.rds")

base::summary(gss_2018_clean2$usetech_tran)

bf_test_manual <- stats::oneway.test(
    formula = usetech_tran ~ DEGREE, 
    data = gss_2018_clean2)
bf_test_manual
```


::::
:::::

**NHST Step 3**

Review and interpret the test statistics: 
Calculate the probability that your test statistic is at least as big as it is if there is no relationship (i.e., the null is true).

The p-value in this case is much less than .05. The value of an $F_{BF}$-statistic being this large or larger happens a tiny percentage of the time when the null hypothesis is true.

**NHST Step 4**

Conclude and write report.

::: {.callout-tip}
> The results show a statistically significant difference of the means of the transformed technology use variable by educational attainment group [$F_{BF}(4, 364.77) = 19.747; p < .05$].
:::


###### BF onewaytests

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-homogeneity-of-variances-bf-onewaytests}
: Testing homogeneity of variances with Brown-Forsythe test from {**onewaytests**}
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: testing-homogeneity-of-variances-bf-onewaytests

onewaytests::bf.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)
```

::::
:::::

###### Welch (book)


**NHST Step 1**

Write the null and alternate hypotheses:

::: {.callout-note}
- **H0**: Time spent using technology is the same across educational attainment groups.
- **HA**: Time spent using technology is not the same across educational attainment groups.
:::

### NHST Step 2

Compute the test statistic. 

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-homogeneity-of-variances-welch-book}
: Testing homogeneity of variances with Welch’s test (book version)
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: homogeneity-of-variances-welch-book

stats::oneway.test(
    formula = USETECH ~ DEGREE, 
    data = gss_2018_clean, 
    var.equal = FALSE
    )

```

::::
:::::

### NHST Step 3

Review and interpret the test statistics: 
Calculate the probability that your test statistic is at least as big as it is if there is no relationship (i.e., the null is true).

The p-value in this case is < 2.2e-16, which is much less than .05. The value of an $F_{W}$-statistic being this large or larger happens a tiny amount of the time when the null hypothesis is true.

### NHST Step 4

Conclude and write report.

::: {.callout-tip}
The results show a statistically significant difference in the mean of the USETECH variable by degree group [$F_{W}(4, 400.31) = 46.06; p < .05$].
:::

In contrast to the original ANOVA with 1404 `r glossary("degrees of freedom")` in the denominator(see: @tbl-f-test-usetech-degree), we have now with 400.31 fewer degrees of freedom. With fewer degrees of freedom, the `r glossary("F-statistic")` has to be a larger number to reach statistical significance.

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-different-f-distributions}
: Comparison of different F-distributions with 2000, 25 and 10 degrees of freedom
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-different-f-distributions
#| fig-cap: "F-distributions with 4 degrees of freedom in the numerator and 10, 25, 2000 in the denominator and one with 2 df and 2000"

ggplot2::ggplot() +
  ggplot2::xlim(0, 5) +
  ggplot2::geom_function(fun = df, 
                           args = list(df1 = 4, df2 = 2000), 
                           ggplot2::aes(color = "4, 2000"),
                           linewidth = .7) +
    ggplot2::geom_function(fun = df, 
                           args = list(df1 = 4, df2 = 25), 
                           ggplot2::aes(color = "4, 25"),
                           linewidth = .7) +
    ggplot2::geom_function(fun = df, 
                           args = list(df1 = 4, df2 = 10), 
                           ggplot2::aes(color = "4, 10"),
                           linewidth = .7) +
    ggplot2::geom_function(fun = df, 
                           args = list(df1 = 2, df2 = 2000), 
                           ggplot2::aes(color = "2, 2000"),
                           linewidth = .7) +
    ggokabeito::scale_color_okabe_ito(
        name = "Degress of freedom\n(num, denominator)",
        breaks = c("4, 2000","4, 25","4, 10", "2, 2000")
    )

```
***

Although there isn’t much difference between three of the distributions, the area under the curves is what matters for the `r glossary("p-value")` cutoff. When the line is just slightly closer to the x-axis, this changes things quickly for the area under the curve.

The thresholds for statistical significance (p < .05) for these three lines are 

- 2.38 for the 2000 degrees of freedom, 
- 2.76 for the 25 degrees of freedom, and 
- 3.48 for the 10 degrees of freedom. 

The numerator degrees of freedom had a much bigger impact on the significance threshold. For example, an ANOVA with 2 degrees of freedom and the same 2000 degrees of freedom in the denominator would have a threshold for (p < .05) significance of 3.00 instead of 2.38 for the 4 and 2000 threshold. You can see the very different function curve in the graph.


::::
:::::


###### Welch onewaytests


:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-homogeneity-of-variances-welch-onewaytests}
: Testing homogeneity of variances with Welch’s test with {**onewaytests**}
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: homogeneity-of-variances-welch-onewaytests

onewaytests::welch.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)
```
***

With the exception of a smaller p-value the results are the same as with `stats::oneway.test()`.
::::
:::::


###### Misc tests with onewaytests

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-homogeneity-of-variances-misc-onewaytests}
: Testing homogeneity of variances with different tests from the {**onewaytests**} package
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: testing-homogeneity-of-variances-misc-onewaytests

onewaytests::homog.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean,
    method = "Levene"
)

onewaytests::homog.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean,
    method = "Bartlett"
)

onewaytests::homog.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean,
    method = "Fligner"
)
```

::::
:::::

:::

::::
:::::

### Normality failed

#### Kruskal-Wallis test

The `r glossary("Kruskal-Wallis", "Kruskal-Wallis test")` is used to compare three or more groups when the normal distribution assumption fails for ANOVA. Like several of the tests used when the outcome is not normally distributed for a t-test, the Kruskal-Wallis (K-W) test compares ranks among groups. Specifically, the observations are put in order by size, and each is assigned a rank. The mean rank for each group is then computed and used to calculate the K-W test statistic, `H`.

:::::{.my-theorem}
:::{.my-theorem-header}
:::::: {#thm-chap07-kruskal-wallis-test}
: Kruskal-Wallis test
::::::
:::
::::{.my-theorem-container}

$$
H = \frac{12}{n(n+1)}\sum_{j=1}^{k}n_{j}(\bar{r_{j}}-\frac{n+1}{2})^2
$$ {#eq-chap07-kruskal-wallis}

***

- **$n$**: overall sample size
- **$n_{j}$**: sample size for group $j$
- **$\bar{r_{j}}$**: mean rank for group $j$


::::
:::::


##### NHST Step 1

Write the null and alternate hypotheses:

::: {.callout-note}
- **H0**: The mean rank of technology use is the same across educational attainment groups
- **HA**: The mean rank of technology use is not the same across educational attainment groups
:::

##### NHST Step 2

Compute the test statistic. 

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-kruskal-wallis-tests}
: Testing normality with the Kruskal-Wallis test
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### stats

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-kruskal-wallis-stats}
: Compare using technology by highest educational attainment with `stats::kruskal.test()`
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: kruskal-wallis-stats

kw_test <- stats::kruskal.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)
kw_test
```
***

The distribution of the H statistic is approximately a `r glossary("chi-squared")` distribution, so the R output lists “chi-squared” instead of `H`.


::::
:::::


###### onewaytests

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-kruskal-wallist-onewaytests}
: Compare using technology by highest educational attainment with `onewaytests::kw.test()`
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: kruskal-wallist-onewaytests

onewaytests::kw.test(
    formula = USETECH ~ DEGREE,
    data = gss_2018_clean
)
```

The value of the statistic is the same as with `stats::kruskal.test()` but the p-value is lower, e.g. it is more stringent.

::::
:::::

:::

::::
:::::




##### NHST Step 3

Review and interpret the test statistics: 
Calculate the probability that your test statistic is at least as big as it is if there is no relationship (i.e., the null is true).

The p-value in both tests, as usual, is very tiny. The value of an `H`-statistic being this large or larger happens a tiny percentage of the time when the null hypothesis is true.

##### NHST Step 4

Conclude and write report.

::: {.callout-tip}
There is a difference in the mean rank for technology use by degree group $[H(4) = 142.21; p < .05]$.
:::

##### Dunn’s post hoc test for Kruskal-Wallis

Like the ANOVA results, the `r glossary("Kruskal-Wallis")` test identifies whether there is a difference somewhere among the means, but it does not identify which groups are different from one another. A post hoc test like `r glossary("Bonferroni")` or `r glossary("Tukey", "Tukey’s HSD")` could help. For K-W, the `r glossary("Dunn", "Dunn’s post hoc test of multiple comparisons")` is useful for identifying which groups are statistically significantly different from which other groups.

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-dunn-post-hoc-test}
: Dunn’s post hoc test for Kruskal-Wallis
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### dunn test

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-dunn-test}
: Dunn’s post hoc test for Kruskal-Wallis
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: dunn-test

dunn.test::dunn.test(
    x = gss_2018_clean$USETECH,
    g = gss_2018_clean$DEGREE,
    method = "bonferroni"
)

```

***

The Dunn’s test is a rank-sum test just like the Mann-Whitney U and can be interpreted in the same way. 

**No difference in technology use**

- for graduate versus bachelor, 
- junior college versus bachelor, 
- junior college versus graduate.

**Differences in technology use**

- less than high school versus bachelor
- less than high school versus graduate
- less than high school versus high school
- less than high school versus junior college
- high school versus bachelor
- high school versus graduate
- high school versus junior college

::: {.callout-tip}
There are differences in technology use between all lower educational attainments (less than high school and high school) versus the higher educational attainments (junior college, bachelor, and graduate). There are also differences between less than high school versus high high school.

There are no differences between the higher educational attainments junior college, bachelor, and graduate.
:::

::::
:::::


###### preparing graph

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-preparing-graph-dunn-test}
: Preparing a graphic for visualizing the differences in the Dunn test
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: preparing-graph-dunn-test

gss_2018_clean3 <- gss_2018_clean2  |> 
    dplyr::mutate(
        usetech_rank = rank(
            x = USETECH, 
            na.last = "keep"
            )
        )

save_data_file("chap07", gss_2018_clean3, "gss_2018_clean3.rds")

# check new variable
summary(object = gss_2018_clean3$usetech_rank)
```

::::
:::::

###### graph

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-graph-dunn-test}
: Visualizing the differences in the Dunn test
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: graph-dunn-test

gss_2018_clean3 <-  base::readRDS("data/chap07/gss_2018_clean3.rds")

gss_2018_clean3 |> 
  ggplot2::ggplot(
      ggplot2::aes(
          y = usetech_rank, 
          x = DEGREE)
      ) +
  ggplot2::geom_jitter(
      ggplot2::aes(color = DEGREE), 
      alpha = .6,
      na.rm = TRUE
      ) +
  ggplot2::geom_boxplot(
      ggplot2::aes(fill = DEGREE), 
      alpha = .4,
      na.rm = TRUE
      ) +
  ggokabeito::scale_color_okabe_ito(guide = "none") +
  ggokabeito::scale_fill_okabe_ito(guide = "none") +
  ggplot2::labs(
      x = "Educational attainment", 
      y = "Ranks of technology use time"
      )
```

***

The graph confirms the result: The three college groups were very similar to one another, and there were differences among the other groups.

::::
:::::


:::

::::
:::::

##### Effect size for Kurskal-Wallis test

`r glossary("Eta-squared")` works for Kruskal-Wallis. (But didn't we say in @sec-chap07-achievement4 that eta-squared has a positive bias and that we therefore should use `r glossary("omega-squared")` as outlined in @eq-chap07-omega-squared?) 

:::::{.my-theorem}
:::{.my-theorem-header}
:::::: {#thm-chap07-eta-squared}
: Computing eta-squared effect size
::::::
:::
::::{.my-theorem-container}
$$
\eta_{H}^2 = \frac{H-k+1}{n-k}
$$ {#eq-chap07-eta-squared}

***

- **H**: Test statistic
- **k**: Groups
- **n**: Number of observations


::::
:::::

Besides a manual calculation I am going also to use {**effectsize**} and {**lsr**}.

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-eta-squared}
: Computation of eta-squared
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### manual

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-eta-squared-manual}
: Computing eta-squared manually
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: eta-squared-manual

k = 5 # group size
n = nrow(tidyr::drop_na(gss_2018_clean, USETECH)) # number of observations
H = kw_test[["statistic"]][["Kruskal-Wallis chi-squared"]] # statistic

(H - k + 1) / (n - k)
```
***

The value .098 is smaller than the omega-squared result of .11.

:::::{.my-assessment}
:::{.my-assessment-header}
:::::: {#cor-chap07-eta-squared}
: Interpretation of eta-squared effect size
::::::
:::
::::{.my-assessment-container}

The cutoff values are the same as for `r glossary("omega-squared")`:

- **Small**: $\eta^2 = .01 \text{ to } \eta^2 < .06$
- **Medium**: $\eta^2 = .06 \text{ to } \eta^2 < .14$
- **Large**: $\eta^2 ≥ .14$
::::
:::::

::: {.callout-tip}
A Kruskal-Wallis test found a statistically significant difference in technology use time at work across educational attainment groups (H = 142.21; p < .05). Based on a Dunn’s post hoc test, those with less than a high school education had statistically significantly lower mean ranked technology use time than all of the other groups (p < .05), and people with a bachelor’s degree, a graduate degree, or a junior college degree had significantly higher mean ranks than those with a high school diploma. There were no statistically significant differences among the three college groups. There was a medium effect size for the relationship between educational attainment and ranked values of technology use time (η2 = .098).
:::
::::
:::::


###### effectsize

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-eta-squared-effectsize}
: Computing eta-squared with {**effectsize**}
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: eta-squared-effectsize

effectsize::eta_squared(
    model = usetech_degree_aov
)
```

***
This is the same result as with omega-squared!
::::
:::::

###### lsr

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-eta-squared-lsr}
: Computing eta-squared with {**effectsize**}
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: eta-squared-lsr

lsr::etaSquared(
    x = usetech_degree_aov
)

```

::::
:::::


:::

::::
:::::




## Achievement 7: Two-way ANOVA {#sec-chap07-achievement7}

### Introduction

- **One-way ANOVA**: A single categorical variable (with 3+ categories) and the means of a continuous variable being compared across the categories.
- **Two-way ANOVA**: Two categorical variables and the means of a continuous variable being compared across both categories.

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-usetech-sex-degree}
: Time spent with technology at job by sex and educational attainment (degree)
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### Boxplot: USETECH by SEX

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-boxplot-usetech-sex}
: Boxplot: Percentage of time using technology at Work by sex 
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-boxplot-usetech-sex
#| fig-cap: "Percentage of time using technology at Work by sex "

gss_2018_clean <- base::readRDS("data/chap07/gss_2018_clean.rds")

gss_2018_clean |> 
    tidyr::drop_na(USETECH, SEX) |> 
    dplyr::group_by(SEX) |> 
    
    ggplot2::ggplot(
        ggplot2::aes(
            x = SEX,
            y = USETECH
        )
    ) +
    ggplot2::geom_boxplot(
        ggplot2::aes(
            fill = SEX
        ),
        alpha = .2
    ) +
    ggplot2::geom_jitter(
        ggplot2::aes(
            color = SEX
        ),
        alpha = 0.6
    ) +
    ggokabeito::scale_color_okabe_ito(guide = "none") +
    ggokabeito::scale_fill_okabe_ito(guide = "none") +
    ggplot2::labs(
        x = "Sex",
        y = "Percent of work time using technology"
    )
```
***

It seems that sex has some relationship to time spent on technology use.
::::
:::::


###### Boxplot: USETECH by SEX & DEGREE

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-boxplot-usetech-sex-degree}
: Boxplot: Percentage of time using technology at Work by sex & degree
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: fig-boxplot-usetech-sex-degree
#| fig-cap: "Percentage of time using technology at Work by sex & degree "

gss_2018_clean |> 
    tidyr::drop_na(USETECH, SEX, DEGREE) |> 
    dplyr::group_by(SEX, DEGREE) |> 
    
    ggplot2::ggplot(
        ggplot2::aes(
            x = DEGREE,
            y = USETECH
        )
    ) +
    ggplot2::geom_boxplot(
        ggplot2::aes(
            fill = SEX
        ),
        alpha = .2
    ) +
    
    ggokabeito::scale_color_okabe_ito(guide = "none") +
    ggokabeito::scale_fill_okabe_ito() +
    ggplot2::labs(
        x = "Educational attainment",
        y = "Percent of work time using technology"
    )
```
***

Males have higher use on technology only in the lowest educational achievement group (< high school.). In both highest groups (bachelor and graduate) males and females use technology at the job approximately at the same rate, whereas females with high school or junior college degree spend using technology at the job more time then males.
::::
:::::

###### means plot1


:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-means-plot1}
: Means plot of technology use at work by educational attainment and sex
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-means-plot1
#| fig-cap: "Means plot of technology use at work by educational attainment and sex"

gss_2018_clean |> 
    tidyr::drop_na(USETECH) |> 
    dplyr::group_by(DEGREE, SEX) |>
    dplyr::summarize(
        means = base::mean(USETECH),
        .groups = 'drop'
    ) |> 
    
    ggplot2::ggplot(
        ggplot2::aes(
            x = DEGREE,
            y = means,
            group = SEX
        )
    ) +
    ggplot2::geom_point(
        ggplot2::aes(
            color = SEX
        ),
        size = 3
    ) +
    ggplot2::geom_line(
        ggplot2::aes(
            color = SEX
        ),
        linewidth = 1,
        linetype = "solid"
    ) +
    ggplot2::ylim(0, 100) +
    ggplot2::labs(
        x = "Educational attainment",
        y = "Percent of time spent using technology"
        ) +
    ggokabeito::scale_color_okabe_ito()
```

::::
:::::

:::::{.my-watch-out}
:::{.my-watch-out-header}
WATCH OUT! Using `group` in the aesthetic of the first layer
:::
::::{.my-watch-out-container}
In this code chunk I have prepared the data.frame, e.g. calculated the means that I used for the graph. But then I needed inside the graph the equivalent of `dplyr::group_by()` as well. Normally the grouping is done implicitly but there are some common cases where the default does not work correctly: 

- At first I tried to connect the categorical data with a line. This requires the argument `group = 1`.
- I needed a `SEX` grouping additionally to the display of `USETECH` by group means.

(See for more detail the help file [Aesthetics: grouping](https://ggplot2.tidyverse.org/reference/aes_group_order.html))

::::
:::::

###### means plot2


:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-means-plot2}
: Means plot of technology use at work by educational attainment and sex
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: fig-means-plot2
#| fig-cap: "Means plot of technology use at work by educational attainment and sex"


gss_2018_clean |>
    ggplot2::ggplot(
        ggplot2::aes(
            x = DEGREE,
            y = USETECH,
            fill = SEX
            )
    ) +
    ggplot2::stat_summary(
        fun =  mean,
        geom = "point",
        size = 3,
        na.rm = TRUE,
        ggplot2::aes(
            color = SEX
        )
    ) +
    ggplot2::stat_summary(
        fun = mean,
        geom = "line",
        linewidth = 1,
        linetype = "solid",
        na.rm = TRUE,
        ggplot2::aes(
            group = SEX,
            color = SEX
        )
    ) +
    ggplot2::ylim(0, 100) +
    ggplot2::labs(
        x = "Educational attainment",
        y = "Percent of time spent using technology"
        ) +
    ggokabeito::scale_color_okabe_ito()
   
    

```

::::
:::::

:::::{.my-watch-out}
:::{.my-watch-out-header}
WATCH OUT! Using `ggplot2::stat_summary()`
:::
::::{.my-watch-out-container}
I have still not much experience with `ggplot2::stat_summary()`. I used it the first time in @cnj-chap03-book-revised, but in that occasion I tried to prevent a warning message and applied in other respects the code provided by the book.

This time I used it for a group summary, e.g. a calculation I would have done with `dplyr::group_by()` and `dplyr::summarize()`.
::::
:::::

###### means data1

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-means-data1}
: Comparing means of technology use at work by educational attainment and sex
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: chap07-means-data1

mean_sd_usetech <- gss_2018_clean |> 
  dplyr::group_by(DEGREE, SEX)  |> 
  tidyr::drop_na(USETECH)  |> 
  dplyr::summarize(
      mean_usetech = base::mean(USETECH),
      sd_usetech = stats::sd(USETECH),
      .groups = 'drop'
      )
mean_sd_usetech
```
***

The biggest difference in time using technology at the job between male and female is in the group with a junior college degree.

But instead of using a visual calculation by head it is better to compute it in detail.
::::
:::::

###### means data2

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-means-data2}
: Comparing means of technology use at work by educational attainment and sex
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: chap07-means-data2

diff_sex_degree <- gss_2018_clean |> 
  dplyr::group_by(DEGREE, SEX)  |> 
  tidyr::drop_na(USETECH)  |> 
  dplyr::summarize(
      mean_usetech = base::mean(USETECH),
      sd_usetech = stats::sd(USETECH),
      .groups = 'drop'
      ) |> 
    dplyr::group_by(DEGREE) |> 
    dplyr::summarize(diffs = diff(mean_usetech))

diff_means <- dplyr::full_join(
    x = mean_sd_usetech,
    y = diff_sex_degree,
    by = dplyr::join_by(DEGREE)
)

diff_means
```
***

The biggest difference in time using technology at the job between male and female is in the group with a junior college degree. The second biggest difference is only half of the first and happens in the high school group. Again about only half is the third difference in graduate, this time the sign is reversed.

These differences confirms quite well with @fig-means-plot1 and @fig-means-plot2.


::::
:::::

:::

::::
:::::

@fig-means-plot1 and @fig-means-plot2 show that there interaction between the two variable `SEX` and `DEGREE.` because the lines are not parallel. Parallel lines would show that the mean of the continuous variable is consistently higher or lower for certain groups compared to others. Parallel lines indicate that there is no interaction between the two categorical variables. 

But when the means plot --- as in our example --- shows lines that diverge or cross then there is an interaction between the categorical variables. The mean of the continuous variable is different at different levels of one categorical variable depending on the value of the other categorical variable. For example, mean technology use is lower for females compared to males for the lowest and highest educational attainment categories, but female technology use is higher than male technology use for the three other categories of educational attainment. The two variables are working together to influence the value of technology use.

### The two-way ANOVA NHST


#### NHST Step 1

Write the null and alternate hypotheses:

::: {.callout-note}
- **H0**: The mean time using technology at work is the same across groups of degree and sex. There is no interaction between the variables `DEGREES` and `SEX.`
- **HA**: The mean time using technology at work is not the same across groups of degree and sex. There is an interaction between the variables `DEGREES` and `SEX.`
:::

#### NHST Step 2

Compute the test statistic. 

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-two-way-anova}
: Two-way ANOVA: Using technology by educational attainment and sex
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: two-way-anova

base::summary(
    stats::aov(
    formula = USETECH ~ DEGREE * SEX,
    data = gss_2018_clean
    )
)

```
***

There are three F-statistics for this ANOVA: one for each of the two individual variables (the `r glossary("main effect", "main effects")`), and one for the interaction term.

When the interaction term is statistically significant, it is interpreted first and the main effects are only interpreted if a main effect variable influences the outcome alone.

**Does a main effect variable influence the outcome alone?**

- If you cannot say anything about the influence of `SEX` on `USETECH` without mentioning `DEGREE` than there was no main effect of `SEX`.
- If tech use had started lower for females than males but increased consistently and statistically significantly for both males and females as educational attainment increased, this would be a main effect of DEGREE. But this is in our example not the case.

**Conclusion**

There is no main effect variable that influences the outcome alone, therefore a repor contains only the interaction term.
::::
:::::


#### NHST Step 3

Review and interpret the test statistics: 
Calculate the probability that your test statistic is at least as big as it is if there is no relationship (i.e., the null is true).

The p-value for the interaction term is with 0.000311 very tiny, and so the value of an F-statistic being as large or larger than the F-statistic for the interaction term happens a tiny percentage of the time when the null hypothesis is true.

#### NHST Step 4

Conclude and write report.

::: {.callout-tip}
There was a statistically significant interaction between degree and sex on mean percent of work time spent using technology [F(4, 1399) = 5.3; p < .001]. The highest mean was 72.1% of time used for technology for males with graduate degrees. The lowest mean was 23.7% of the time for females with less than a high school diploma. The interaction between degree and sex shows that time spent on technology use increases more quickly for females, with both males and females eventually having high tech use in the top two educational attainment groups.
:::

### Post hoc test for two-way ANOVA

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-two-way-anova-tukey-test}
: Tukey’s HSD post hoc test for two-way ANOVA of USETECH by DEGREE and SEX
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: two-way-anova-tukey-test

stats::TukeyHSD(
    stats::aov(
    formula = USETECH ~ DEGREE * SEX,
    data = gss_2018_clean
    )
)

```
***

1. The first section under `$DEGREE` was comparing groups of `DEGREE` to each other. 
2. The second section under `$SEX` was comparing males and females to each other. 
3. The third section was the interaction, comparing groups of `DEGREE*SEX` with each other.
    a) The first row in this last section is high school:male-< high school:male, which compares high school male to less than high school male.
    b) The difference between the means: diff = 17.81.
    c) The confidence interval is found around the difference (95% CI: 2.73 to 32.90).
    d) The p-value for the difference between the means (p = 0.007) is statistically significant

This indicates that there is a statistically significant (p < .05) difference of 17.81 between the mean percentage time of technology use for males with less than high school compared to males with high school *in the sample*, and that the difference between the mean of these two groups is likely somewhere between 2.73 and 32.90 in the population this sample came from.


There are so many groups with significant differences that it would be more useful to just include the boxplot from the exploratory analysis or the means plot of @fig-means-plot1 and a paragraph about any interesting overall patterns in the comparisons. For instance:

::: {.callout-tip}
There is a trend that with higher educational attainment the time spent with technology at work grows. Starting from the same relatively low level of 25% the use of technology with higher degrees rises faster for female than for males until the junior college degree. In the following higher educational attainment groups (bachelor and graduate) the time used with technology decreases for females whereas it continues to increase for males. Both trends cross at the bachelor level with about 68% and reach 66% for female and 72% for males at the graduate level. 

The biggest difference in time using technology at the job between male and female is in the group with a junior college degree (`junior college:female-junior college:male`). 

The second biggest difference is only half of the first and happens in the high school group (`high school:female-< high school:male`). 

All the other differences between female and males at the same degree level are not statistically significant with p <= .05.
:::
 
 
::::
:::::

### Two-way ANOVA assumptions

#### Normality

Testing the normality assumption is more difficult as with the one-way ANOVA, we would need to look at each group. Since there are five degree groups, two sex groups, and 10 degree-by-sex groups (e.g., male and less than high school). Instead of checking normality one group at a time when there are a large number of groups in an ANOVA model, this assumption can be checked by examining the `r glossary("residually", "residuals")`. The residuals are the distances between the value of the outcome for each person and the value of the group mean for that person. When the residuals are normally distributed, this indicates that the values in each group are normally distributed around the group mean.

:::::{.my-example}
:::{.my-example-header}
:::::: {#exm-chap07-testing-normality-two-way-anova}
: Testing normality for two-way ANOVA
::::::
:::
::::{.my-example-container}

::: {.panel-tabset}

###### Shapiro-Wilk test

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-test-normality-residuals-shapiro-wilk}
: Shapiro-Wilk test for normal distribution by groups
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: test-normality-residuals-shapiro-wilk

stats::shapiro.test(
    aov_test <- stats::aov(
    formula = USETECH ~ DEGREE * SEX,
    data = gss_2018_clean
    )$residuals
)

```
***
Instead of providing the result of the model fitting with the `stats::aov()` function I have nested the function into the `r glossary("Shapiro-Wilk")` test. The statistically significant p-value means that we have to reject the null hypotheses ("The distribution is normal"). So, this test shows that the residuals fail the normality assumption.

To confirm the result it is helpful to graph the residuals.

::::
:::::


###### Graphing the residuals

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-testing-normality-residuals-graph}
: Inspecting normality with a graph of the residuals
::::::
:::
::::{.my-r-code-container}

```{r}
#| label: testing-normality-residuals-graph
#| fig-cap: "Distribution of residuals from ANOVA explaining tech use at work based on educational attainment and sex"
#| fig-height: 10


aov_residuals_df <- tibble::tibble(residuals =
        stats::aov(
        formula = USETECH ~ DEGREE * SEX,
        data = gss_2018_clean
        )$residuals
    )

p1 <- my_hist_dnorm(
    df = aov_residuals_df,
    v = aov_residuals_df$residuals,
    n_bins = 30,
    x_label = "Residuals with 30 bins as in the book")

p2 <- my_hist_dnorm(
    df = aov_residuals_df,
    v = aov_residuals_df$residuals,
    n_bins = 20,
    x_label = "Residuals with 20 bins")

gridExtra::grid.arrange(
    p1, p2,
    nrow = 2
)
```
***
The graph is clearly not normal. The insinuated bi-modality in the text of the book is in my opinion an artifact of the chosen number of bins. To compare I have graphed two histograms with 30 and 20 bins.
::::
:::::

:::

::::
:::::

#### Homogeneity of variances

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-two-way-levene-test}
: Levene’s test for two-way ANOVA
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: two-way-levene-test
#| results: hold

glue::glue("############### default: `center = mean` ####################")
car::leveneTest(
    y = USETECH ~ DEGREE * SEX,
    center = mean,
    data = gss_2018_clean
)

glue::glue(" ")
glue::glue("############### default: `center = median` #################")
car::leveneTest(
    y = USETECH ~ DEGREE * SEX,
    center = median,
    data = gss_2018_clean
)

```
***
:::::{.my-watch-out}
:::{.my-watch-out-header}
WATCH OUT! What is the center of each group?
:::
::::{.my-watch-out-container}
Using the means at the center is the original test. The default `center = median` provides a more robust test. But even this more robust test is also statistically significant. So the homogeneity of variance has to be rejected in both cases.
::::
:::::



The results were statistically significant so the null hypothesis was rejected in this test as well. The equal variances assumption was not met. 

The two-way ANOVA had failed its assumptions.
::::
:::::

### Alternatives

#### Friedman test

The books mentions `stats::friedman.test()`. But it turns out that the test result is not statistically significant. This seems unlikely given all the other information we have about the data distribution.

#### Compute ANOVA with ranks of the otucome variable

We had already computed the ranks of USETECH for the Dunn’s test earlier in @exm-chap07-dunn-post-hoc-test. We can load the appropriate `gss_2018_clean3.rds` data and use the variable `usetech_rank`.

:::::{.my-r-code}
:::{.my-r-code-header}
:::::: {#cnj-chap07-two-way-ranked-anova}
: Two-way ANOVA ranked technology use by degree and sex
::::::
:::
::::{.my-r-code-container}
```{r}
#| label: two-way-ranked-anova

gss_2018_clean3 <- base::readRDS("data/chap07/gss_2018_clean3.rds")

base::summary(
    stats::aov(
        formula = usetech_rank ~ DEGREE * SEX, 
        data = gss_2018_clean3
        )
)
```
***

::: {.callout-tip}
A two-way ANOVA with ranked technology time use as the outcome found a statistically significant interaction between degree and sex (p < .05). The overall pattern of results indicates that males and females with less than a high school education use technology the least, while those with higher educational attainment use technology the most. Males and females differ a lot in use of technology for those with a junior college degree, with females having a junior college degree having the highest use of technology of all females.
:::

::::
:::::

:::::{.my-watch-out}
:::{.my-watch-out-header}
WATCH OUT! What's the difference between ranked and not ranked?
:::
::::{.my-watch-out-container}
I have to confess that I do not understand the difference between our (wrong?) tests with assuming that the normality and homogeneity of variance assumptions hold and here now the ranked version of the two-way ANOVA. It seems to me that the results are the same. Even the both graphs are almost identical.
::::
:::::


#### Box-Cox transformation

Another suggestion for alternative test is the Box-Cox transformation on the outcome variable. The Box-Cox power transformations were developed to reduce the non-normality of residuals, so they might be useful here. The original paper by Box and Cox explains the transformations [@box1964], and there are numerous tutorials on the use of them [@wikipedia2021a; @zach2020; @glenn.db; @lane2017].



## Exercises (empty)



## Glossary

```{r}
#| label: glossary-table
#| echo: false

glossary_table()
```

------------------------------------------------------------------------


## Session Info {.unnumbered}

:::::{.my-r-code}
:::{.my-r-code-header}
Session Info
:::
::::{.my-r-code-container}

```{r}
#| label: session-info

sessioninfo::session_info()
```


::::
:::::
